stages:
  - test

test_project:
  stage: test
  script:
    - set -o pipefail && xcodebuild clean -workspace Box-Office-Movies.xcworkspace -scheme Box-Office-Movies | xcpretty
    - set -o pipefail && xcodebuild test -workspace Box-Office-Movies.xcworkspace -scheme Box-Office-Movies -derivedDataPath Build/ -destination 'platform=iOS Simulator,name=iPhone 8,OS=13.0' | xcpretty
    - set -o pipefail && echo "test_coverage=`xcrun xccov view Build/Logs/Test/*.xcresult/*_Test/action.xccovreport | grep 'Box-Office-Movies.app' | head -1 | perl -pe 's/.+?(\d+\.\d+%).+/\1/'`"
  tags:
    - iOS-13.0
    - Xcode-11

test_core:
  stage: test
  script:
    - set -o pipefail && xcodebuild clean -workspace Box-Office-Movies.xcworkspace -scheme Box-Office-Movies-Core | xcpretty
    - set -o pipefail && xcodebuild test -workspace Box-Office-Movies.xcworkspace -scheme Box-Office-Movies-Core -derivedDataPath Build/ -destination 'platform=iOS Simulator,name=iPhone 8,OS=13.0' | xcpretty
    - set -o pipefail && echo "test_coverage=`xcrun xccov view Build/Logs/Test/*.xcresult/*_Test/action.xccovreport | grep 'Box_Office_Movies_Core.framework' | head -1 | perl -pe 's/.+?(\d+\.\d+%).+/\1/'`"
  tags:
  - iOS-13.0
  - Xcode-11
